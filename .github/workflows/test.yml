name: Node.js CI

on:
  push:
    branches: [tests-branch]
  pull_request:
    branches: [main, master, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      neo4j:
        image: neo4j:latest
        env:
          NEO4J_AUTH: neo4j/testpassword
          NEO4J_ACCEPT_LICENSE_AGREEMENT: 'yes'
          NEO4J_apoc_export_file_enabled: true
          NEO4J_apoc_import_file_enabled: true
          NEO4J_apoc_import_file_use__neo4j__config: true
        ports:
          - 7474:7474
          - 7687:7687
        options: >-
          --health-cmd "cypher-shell -u neo4j -p testpassword 'RETURN 1'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      mongodb:
        image: mongo:latest
        ports:
          - 27017:27017

    steps:
    - uses: actions/checkout@v3

    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Wait for Neo4j
      run: |
        timeout 60s bash -c 'until nc -z localhost 7687; do sleep 1; done'

    - name: Run tests
      env:
        MONGODB_URI: mongodb://localhost:27017/pedagonet_test
        SCHOOL_DB_URI: mongodb://localhost:27017/schoolpedagonet_test
        NEO4J_URI: bolt://localhost:7687
        NEO4J_USERNAME: neo4j
        NEO4J_PASSWORD: testpassword
        JWT_SECRET: test_secret_key
        NODE_ENV: test
        EMAIL_HOST: smtp.gmail.com
        EMAIL_PORT: 587
        EMAIL_USER: test@example.com
        EMAIL_PASS: test_password
        VERIFICATION_CODE_EXPIRY: 600
      run: npm test